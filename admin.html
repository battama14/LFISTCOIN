<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Envoi Newsletter</title>

  <!-- Firebase SDK modules -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Expose firebase pour utilisation globale
    window.firebaseApp = initializeApp({
      apiKey: "AIzaSyDo6bGH2ofNNhL6SBB9rJ3ZaBMzldp0qp8",
      authDomain: "lfistdur.firebaseapp.com",
      databaseURL: "https://lfistdur-default-rtdb.firebaseio.com",
      projectId: "lfistdur",
      storageBucket: "lfistdur.firebasestorage.app",
      messagingSenderId: "3612454131",
      appId: "1:3612454131:web:dc3eeab8ded57a40671b86"
    });
    window.db = getDatabase(window.firebaseApp);
  </script>

  <!-- EmailJS classique (pas module) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <script>
    // Initialise EmailJS dans le contexte global
    emailjs.init('ikFvXb-BD1-DJsPCV');

    // Fonction d'envoi newsletter (accès à Firebase via window.db)
    async function sendNewsletter(messageContent) {
      try {
        const newsletterRef = window.firebase.database().ref('newsletter');
        const snapshot = await window.firebase.database().get(ref(window.db, 'newsletter'));
        const data = snapshot.val();

        if (!data) {
          console.log("Aucun email trouvé dans la newsletter.");
          return;
        }

        const emails = Object.values(data);

        const envois = emails.map(entry =>
          emailjs.send('service_keqvfcw', 'template_4jz4w3e', {
            user_email: entry.email,
            message: messageContent
          })
        );

        await Promise.all(envois);
        alert("Newsletter envoyée avec succès !");
      } catch (err) {
        console.error("Erreur envoi newsletter :", err);
        alert("Erreur lors de l'envoi de la newsletter.");
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('sendBtn').addEventListener('click', () => {
        const message = document.getElementById('messageInput').value.trim();
        if (message) {
          sendNewsletter(message);
        } else {
          alert("Veuillez écrire un message avant d'envoyer.");
        }
      });
    });
  </script>

</head>
<body>
  <h1>Admin - Envoi Newsletter</h1>
  <textarea id="messageInput" rows="6" cols="60" placeholder="Tapez ici le message à envoyer..."></textarea><br/>
  <button id="sendBtn">Envoyer la newsletter</button>
</body>
</html>
